<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My List - Movie Website</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/css/styles.css" />
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <link rel="stylesheet" href="/css/mylist.css" />
</head>
<body>
  <%- include('../partials/navbar') %>

  <section class="container my-5 pt-5">
    <h1 class="mb-4 text-center fw-bold">My Watchlist</h1>

    <div class="row">
      <% if (!watchlist || watchlist.length === 0) { %>
        <div class="col-12 text-center">
          <p class="text-muted">Your watchlist is empty.</p>
          <a href="/movies" class="btn btn-primary mt-3">Browse Movies</a>
        </div>
      <% } else { %>
        <% watchlist.forEach(movie => { %>
          <div class="col-md-3 mb-4 position-relative">
            <div class="movie-card">
              <a href="/movie/<%= movie._id %>">
                <img src="<%= movie.posterURL %>" class="img-fluid rounded shadow" alt="<%= movie.title %> poster" />
              </a>
              <div class="movie-info">
                <h5 class="movie-title"><%= movie.title %></h5>
                <button 
                  class="btn btn-danger btn-sm delete-btn" 
                  data-movie-id="<%= movie._id %>"
                  onclick="removeFromWatchlist('<%= movie._id %>')">
                  <i class="fas fa-trash-alt"></i> Remove
                </button>
              </div>
            </div>
          </div>
        <% }) %>
      <% } %>
    </div>
  </section>

  <% if (user && user.role === 'admin') { %>
    <a href="/admin/<%= user.id %>" class="sticky-button">
      <i class="fa-solid fa-plus"></i>
    </a>
  <% } %>

  <%- include('../partials/footer') %>

  <script type="module">
    import showFunToast from "/js/toast.js";

    window.removeFromWatchlist = async function(movieId) {
      try {
        const response = await fetch(`/api/mylist/${movieId}`, {
          method: 'DELETE',
          credentials: 'include'
        });

        const data = await response.json();

        if (response.ok) {
          showFunToast("✅ Movie removed from watchlist", "linear-gradient(to right, #00eaff, #00a8b5)");
          // Remove the movie card from the DOM
          const movieCard = document.querySelector(`[data-movie-id="${movieId}"]`).closest('.col-md-3');
          movieCard.remove();
          
          // If no movies left, show empty state
          const remainingMovies = document.querySelectorAll('.movie-card');
          if (remainingMovies.length === 0) {
            location.reload(); // Reload to show empty state
          }
        } else {
          showFunToast(data.message || "❌ Failed to remove movie", "red");
        }
      } catch (error) {
        console.error('Error:', error);
        showFunToast("❌ An error occurred", "red");
      }
    };
  </script>
    <script src="/js/script.js"></script>
</body>
</html>
